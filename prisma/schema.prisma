// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  headId      String?
  sector      String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  units       DepartmentUnit[]
  projects    Project[]
  head        User?           @relation("DepartmentHead", fields: [headId], references: [id])
  events      Event[]         @relation("EventDepartments")
  requestForms RequestForm[]  @relation("RequestFormDepartment")

  @@map("departments")
}

model DepartmentUnit {
  id           String   @id @default(cuid())
  name         String
  departmentId String
  managerId    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  manager      User?      @relation("UnitManager", fields: [managerId], references: [id])
  events       Event[]    @relation("EventUnits")

  @@map("department_units")
}

model User {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  fullName     String
  phone        String
  dob          String
  gender       String
  email        String   @unique
  role         String
  departmentId String?
  employeeId   String?
  position     String
  hireDate     String
  salary       Float
  avatar       String?
  isActive     Boolean  @default(true)
  permissions  Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  departmentHeadOf Department[]        @relation("DepartmentHead")
  unitManagerOf    DepartmentUnit[]    @relation("UnitManager")
  projectsManaged  Project[]           @relation("ProjectManager")
  tasksAssigned    Task[]             @relation("TaskAssignee")
  approvals        Approval[]
  auditLogs        AuditLog[]          @relation("AuditLogUser")
  createdEvents    Event[]             @relation("EventCreatedBy")
  events           Event[]             @relation("EventUsers")
  requestsCreated  RequestForm[]       @relation("RequestFormRequester")
  requestApprovals RequestApproval[]    @relation("RequestApprovalUser")
  requestComments  RequestComment[]     @relation("RequestCommentUser")

  @@map("users")
}

model Project {
  id          String    @id @default(cuid())
  name        String
  code        String    @unique
  description String?
  clientName  String?
  departmentId String
  managerId  String
  budget      Float
  spent       Float     @default(0)
  startDate   String
  endDate     String
  status      String    @default("planning") // planning, active, on_hold, completed, cancelled
  priority    String    @default("medium")   // low, medium, high, critical
  progress    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  department  Department @relation(fields: [departmentId], references: [id])
  manager     User       @relation("ProjectManager", fields: [managerId], references: [id])
  milestones  Milestone[]
  tasks       Task[]
  approvals   Approval[]

  @@map("projects")
}

model Milestone {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  description String?
  dueDate     String
  status      String   @default("pending") // pending, in_progress, completed, overdue
  progress    Int      @default(0)
  budget      Float    @default(0)
  spent       Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@map("milestones")
}

model Task {
  id             String   @id @default(cuid())
  projectId      String
  milestoneId    String?
  name           String
  description    String?
  assigneeId     String?
  status         String   @default("todo") // todo, in_progress, review, completed
  priority       String   @default("medium") // low, medium, high
  startDate      String?
  dueDate        String?
  estimatedHours Float?
  actualHours    Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone      Milestone? @relation(fields: [milestoneId], references: [id])
  assignee       User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])

  @@map("tasks")
}

model Approval {
  id         String   @id @default(cuid())
  projectId  String
  userId     String
  level      String   // director, ceo
  status     String   @default("pending") // pending, approved, rejected
  actionDate String?
  comments   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@map("approvals")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  userSnapshot Json     // Stores user details at time of action {id, fullName, email, role, departmentId}
  actionType   String   // CREATE, UPDATE, DELETE, READ, USER_LOGIN, etc.
  entityType   String   // User, Project, Department, etc.
  entityId     String?
  description  String
  isSuccessful Boolean  @default(true)
  previousData Json?    // JSON snapshot of data before change
  newData      Json?    // JSON snapshot of data after change
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  // Relations
  user         User?    @relation("AuditLogUser", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([actionType])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model Event {
  id            String    @id @default(cuid())
  title         String
  description   String?
  tags          String[]
  link          String?
  startDateTime DateTime
  endDateTime   DateTime
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String?

  // Relations
  createdBy     User?             @relation("EventCreatedBy", fields: [createdById], references: [id])
  users         User[]            @relation("EventUsers")
  departments   Department[]      @relation("EventDepartments")
  units         DepartmentUnit[]  @relation("EventUnits")

  @@map("events")
}

model RequestForm {
  id          String   @id @default(cuid())
  name        String
  description String
  requestedBy String
  departmentId String
  type        String   // office_supplies, equipment, travel, training, other
  status      String   @default("pending_dept_head") // pending_dept_head, pending_admin_head, approved, rejected
  requestDate String
  items       Json?    // Array of Item objects
  amount      Float?
  currency    String?  @default("NGN")
  priority    String?  @default("medium") // low, medium, high, urgent
  category    String?
  attachments Json?    // Array of file paths/URLs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  requestedByUser User              @relation("RequestFormRequester", fields: [requestedBy], references: [id])
  department      Department        @relation("RequestFormDepartment", fields: [departmentId], references: [id])
  approvals       RequestApproval[]
  comments        RequestComment[]

  @@index([status])
  @@index([departmentId])
  @@index([requestedBy])
  @@index([type])
  @@map("request_forms")
}

model RequestApproval {
  id           String   @id @default(cuid())
  requestFormId String
  userId       String
  level        String   // dept_head, admin_head
  status       String   @default("pending") // pending, approved, rejected
  actionDate   String?
  comments     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  requestForm RequestForm @relation(fields: [requestFormId], references: [id], onDelete: Cascade)
  user        User        @relation("RequestApprovalUser", fields: [userId], references: [id])

  @@index([requestFormId])
  @@index([userId])
  @@index([status])
  @@map("request_approvals")
}

model RequestComment {
  id           String   @id @default(cuid())
  requestFormId String
  userId       String
  content      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  requestForm RequestForm @relation(fields: [requestFormId], references: [id], onDelete: Cascade)
  user        User        @relation("RequestCommentUser", fields: [userId], references: [id])

  @@index([requestFormId])
  @@index([userId])
  @@map("request_comments")
}